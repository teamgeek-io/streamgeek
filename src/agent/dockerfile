FROM node:22-alpine

RUN apk add --no-cache ffmpeg

WORKDIR /app

# Copy package files first
COPY package.json pnpm-lock.yaml ./

# Install pnpm
RUN corepack enable

# Install all dependencies (ignore scripts like prepare)
RUN pnpm install --ignore-scripts

# Copy the source code, tsconfig, and prisma schema
COPY src ./src
COPY tsconfig.json ./

# Remove dev dependencies to reduce image size
# ToDo: remove orchestrator dependencies
RUN pnpm install --prod --ignore-scripts

RUN mkdir -p /app/input /app/output

WORKDIR /app

EXPOSE 3000

CMD ["pnpx", "tsx", "src/agent/index.ts"]